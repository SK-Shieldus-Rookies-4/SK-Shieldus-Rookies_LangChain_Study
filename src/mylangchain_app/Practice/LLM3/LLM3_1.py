import os
from dotenv import load_dotenv
from langchain_community.document_loaders import PyPDFLoader
from langchain.text_splitter import RecursiveCharacterTextSplitter
from langchain_community.vectorstores import FAISS
from langchain.chains import RetrievalQA
from langchain.prompts import PromptTemplate
from langchain_upstage import ChatUpstage, UpstageEmbeddings

# 🌟 Mac OS 환경에서 FAISS/OpenMP 충돌 방지
os.environ['KMP_DUPLICATE_LIB_OK'] = 'TRUE'


def main():
    # 0. API 키 로드
    load_dotenv()
    UPSTAGE_API_KEY = os.getenv("UPSTAGE_API_KEY")

    if not UPSTAGE_API_KEY:
        print("❌ 오류: UPSTAGE_API_KEY가 없습니다. .env 파일을 확인하세요.")
        return

    # 0단계: 문서 로드
    FILE_PATH = "../data/콘텐츠분쟁해결_사례.pdf"
    print("✅ 0단계: 문서 로드 시작...")
    loader = PyPDFLoader(FILE_PATH)
    documents = loader.load()
    print(f"   -> {len(documents)} 페이지 로드 완료")

    # 1단계: 문서 분할 설정
    print("\n✅ 1단계: 문서 분할 시작...")
    text_splitter = RecursiveCharacterTextSplitter(
        chunk_size=1500,       # 권장 범위: 1200~1800자
        chunk_overlap=300,     # 200~400자 권장
        separators=[
            "\n【사건개요】",
            "\n【쟁점사항】",
            "\n【처리경위】",
            "\n【처리결과】",
            "\n■", "\n\n", "\n", ".", " ", ""
        ]
    )
    split_docs = text_splitter.split_documents(documents)
    print(f"   -> 분할된 문서 조각 수: {len(split_docs)}")

    # 2단계: 임베딩 모델 설정
    print("\n✅ 2단계: 임베딩 모델 생성...")
    embeddings = UpstageEmbeddings(
        model="solar-embedding-1-large",
        upstage_api_key=UPSTAGE_API_KEY
    )
    vectorstore = FAISS.from_documents(split_docs, embeddings)
    print("   -> 벡터스토어 생성 완료")

    # 3단계: 검색기 설정
    print("\n✅ 3단계: 검색기 설정...")
    retriever = vectorstore.as_retriever(
        search_type="similarity",
        search_kwargs={"k": 5}
    )
    print("   -> 검색기 설정 완료")

    # 4단계: LLM 설정
    print("\n✅ 4단계: LLM 설정...")
    llm = ChatUpstage(
        model="solar-pro",
        base_url="https://api.upstage.ai/v1",
        temperature=0.2,
    )
    print("   -> LLM 설정 완료")

    # 5단계: 법률 자문 프롬프트 작성
    print("\n✅ 5단계: 프롬프트 작성...")
    prompt_template = """
당신은 콘텐츠 분야 전문 법률 자문가입니다. 
아래 분쟁조정 사례들을 바탕으로 정확하고 전문적인 법률 조언을 제공해주세요.

관련 분쟁사례:
{context}

상담 내용: {query}

답변 가이드라인:
1. 제시된 사례들을 근거로 답변하세요
2. 관련 법령이나 조항이 있다면 명시하세요
3. 비슷한 사례의 처리경위와 결과를 참고하여 설명하세요
4. 실무적 해결방안을 단계별로 제시하세요
5. 사례에 없는 내용은 "제시된 사례집에서는 확인할 수 없습니다"라고 명시하세요

전문 법률 자문:"""

    prompt = PromptTemplate(
        template=prompt_template,
        input_variables=["context", "query"]
    )
    print("   -> 프롬프트 작성 완료")

    # 6단계: QA 체인 생성
    print("\n✅ 6단계: QA 체인 생성...")
    qa_chain = RetrievalQA.from_chain_type(
        llm=llm,
        retriever=retriever,
        chain_type="stuff",  # stuff 체인을 사용
        return_source_documents=True,
        input_key="query",  # 외부에서 넣는 키
    )
    print("   -> QA 체인 생성 완료")
    print("QA Chain input keys:", qa_chain.input_keys)

    # 7단계: 테스트 질문
    test_questions = [
        "온라인 게임에서 시스템 오류로 아이템이 사라졌는데, 게임회사가 복구를 거부하고 있습니다. 어떻게 해결할 수 있나요?",
        "인터넷 강의를 중도 해지하려고 하는데 과도한 위약금을 요구받고 있습니다. 정당한가요?",
        "무료체험 후 자동으로 유료전환되어 요금이 청구되었습니다. 환불 가능한가요?",
        "미성년자가 부모 동의 없이 게임 아이템을 구매했습니다. 환불받을 수 있는 방법이 있나요?",
        "온라인 교육 서비스가 광고와 다르게 제공되어 계약을 해지하고 싶습니다. 가능한가요?"
    ]

    print("\n✅ 7단계: 테스트 질문 실행...")
    for q in test_questions:
        print("\n===================================================")
        print(f"🔍 질문: {q}")
        print("===================================================")
        result = qa_chain.invoke({"query": q})
        print("✅ [전문 법률 조언]")
        print(result["result"])

        print("\n📜 [참조 문서]")
        for i, doc in enumerate(result["source_documents"], 1):
            print(f"  {i}. 페이지: {doc.metadata.get('page', 'Unknown')}")

    # 8단계: 선택 - 분쟁 유형 분류 함수
    def classify_dispute_type(query):
        game_keywords = ["게임", "아이템", "계정", "캐릭터", "레벨", "길드", "온라인게임"]
        elearning_keywords = ["강의", "온라인교육", "이러닝", "수강", "환불", "화상교육"]
        web_keywords = ["웹사이트", "무료체험", "자동결제", "구독", "사이트"]

        query_lower = query.lower()

        if any(keyword in query_lower for keyword in game_keywords):
            return "게임"
        elif any(keyword in query_lower for keyword in elearning_keywords):
            return "이러닝"
        elif any(keyword in query_lower for keyword in web_keywords):
            return "웹콘텐츠"
        else:
            return "기타"

    # 분쟁 유형 테스트
    print("\n✅ 8단계: 분쟁 유형 분류 테스트...")
    for q in test_questions:
        print(f"'{q}' → {classify_dispute_type(q)}")


if __name__ == "__main__":
    main()

# 출력결과
"""
✅ 0단계: 문서 로드 시작...
   -> 109 페이지 로드 완료

✅ 1단계: 문서 분할 시작...
   -> 분할된 문서 조각 수: 104

✅ 2단계: 임베딩 모델 생성...
   -> 벡터스토어 생성 완료

✅ 3단계: 검색기 설정...
   -> 검색기 설정 완료 (k=5)

✅ 4단계: LLM 설정...
   -> LLM 설정 완료

✅ 5단계: 프롬프트 작성...
   -> 프롬프트 작성 완료

✅ 6단계: QA 체인 생성...
   -> QA 체인 생성 완료
QA Chain input keys: ['query']

✅ 7단계: 테스트 질문 실행...

===================================================
🔍 질문: 온라인 게임에서 시스템 오류로 아이템이 사라졌는데, 게임회사가 복구를 거부하고 있습니다. 어떻게 해결할 수 있나요?
===================================================
✅ [전문 법률 조언]
제공된 사례를 바탕으로 다음과 같이 답변드립니다:

1. **계정 소유권 확인**:  
   - 게임사가 계정 명의자와 실소유주가 다를 경우 복구를 거부하는 사례가 있습니다(2006년 사례).  
   - 본인 명의의 계정임을 증명할 수 있는 정보(결제 내역, 인증 기록 등)를 준비해야 합니다.

2. **시스템 오류 증거 수집**:  
   - 동일한 시간대에 다른 사용자도 유사한 오류를 경험했는지 확인합니다(2009년 사례 참조).  
   - 오류 발생 시점의 스크린샷, 로그 기록, 고객센터 문의 내역 등을 보관하세요.

3. **게임사 약관 및 정책 검토**:  
   - 프로그램 오류 시 복구 가능성을 명시한 경우(2006년 프로그램 오류 사례), 이를 근거로 요청할 수 있습니다.  
   - 단, 해킹 아이템이나 불법 거래로 인한 회수일 경우 복구가 어려울 수 있습니다(2007년 사례).

4. **공식 채널로 요청**:  
   - 게임사의 고객센터 또는 게시판을 통해 공식적으로 복구를 요청하세요.  
   - 2006년 사례에서는 게시판 문의 후 복구된 사례가 있으나, 2009년 사례에서는 통신 환경 문제로 거부되기도 했습니다.

5. **소비자 기관 상담**:  
   - 한국소비자원과 같은 기관에 조정을 신청할 수 있습니다.  
   - 단, 게임사의 약관에 따라 복구 불가 시 소비자원도 한계가 있을 수 있습니다.

6. **법적 검토**:  
   - 민법 제250조(도품·유실물 특례) 등 관련 법률을 참고할 수 있으나, 게임머니는 금전으로 간주되지 않을 수 있습니다.  
   - 약관상 "데이터 소멸 시 책임 없음" 조항이 있다면 법적 대응이 어려울 수 있습니다.

**추천 조치**:  
- 우선 게임사에 오류 증거를 제시하며 복구를 요청하고, 거부 시 한국소비자원(☎ 1372)에 상담을 신청하세요.  
- 계정 소유권 문제와 시스템 오류 여부를 명확히 구분하는 것이 중요합니다.  

※ 단, 제공된 사례 외 추가 정보(예: 게임사명, 오류 발생 일시)가 있다면 더 정확한 조언이 가능합니다.

📜 [참조 문서]
  1. 페이지: 8
  2. 페이지: 28
  3. 페이지: 2
  4. 페이지: 9
  5. 페이지: 10

===================================================
🔍 질문: 인터넷 강의를 중도 해지하려고 하는데 과도한 위약금을 요구받고 있습니다. 정당한가요?
===================================================
✅ [전문 법률 조언]
인터넷 강의 중도 해지 시 과도한 위약금 요구는 **정당하지 않을 수 있습니다**. 한국소비자원의 조정결정례에 따르면, 다음과 같은 기준을 참고할 수 있습니다:

1. **법적 근거**  
   - **방문판매 등에 관한 법률 제30조**: 계약 해지 시 소비자에게 발생한 손실을 현저히 초과하는 위약금을 청구할 수 없으며, 실제 제공된 서비스 대가를 초과한 금액 반환을 거부할 수 없습니다.  
   - **소비자분쟁해결기준(공정위고시)**:  
     - 해지일까지의 이용일수 해당 금액과 총 이용금액의 **10% 이내** 위약금을 공제한 후 환급해야 합니다.  
     - 사은품은 미사용 시 반환하거나 비용을 공제하지 않아야 합니다.  
     - 계약서에 명시되지 않은 추가 비용(교재비, 가입비 등)은 공제 대상이 아닙니다.

2. **조정결정례 사례**  
   - **2007_인터넷교육서비스 중도해지 요구**: 피청구인이 가입비·화상교육비 등을 공제하려 했으나, 계약서에 기재되지 않은 항목은 공제할 수 없다고 판단되었습니다.  
   - **2010_인터넷 화상 강의 환급 요구**: 서비스 개통일부터 해지일까지의 실제 이용일수만 공제해야 하며, 위약금은 총 금액의 10% 이내로 제한됩니다.  
   - **2008_온라인 통신교육서비스 환급 요구**: 할인된 금액이 아닌 계약서상 명시된 금액을 기준으로 환급해야 하며, 과도한 위약금은 부당합니다.

3. **행동 권장사항**  
   - **계약서 확인**: 계약서에 명시된 이용료, 위약금 조건, 제공 서비스 내용을 확인하세요.  
   - **이용 기록 확보**: 실제 이용한 강의 일수, 미사용 사은품 등을 증명할 자료를 준비하세요.  
   - **한국소비자원 상담**: 과도한 위약금 요구 시 [한국소비자원(☎ 1372)](https://www.kca.go.kr)에 분쟁 조정을 신청할 수 있습니다.

결론적으로, 계약서에 명시되지 않은 비용이나 총 금액의 10%를 초과하는 위약금은 부당할 수 있으므로, 위 기준을 근거로 환급 요청을 재검토해 보시기 바랍니다.

📜 [참조 문서]
  1. 페이지: 3
  2. 페이지: 62
  3. 페이지: 60
  4. 페이지: 72
  5. 페이지: 64

===================================================
🔍 질문: 무료체험 후 자동으로 유료전환되어 요금이 청구되었습니다. 환불 가능한가요?
===================================================
✅ [전문 법률 조언]
제공된 사례에 따르면, 무료체험 후 자동 유료전환으로 인한 요금 청구 시 환불 가능성은 다음과 같은 요소에 따라 결정됩니다:

1. **사업자의 고지의무 이행 여부**  
   - 사업자가 무료체험 기간 내 해지하지 않을 경우 유료전환된다는 사실을 **명확히 고지**했는지 확인해야 합니다.  
   - 예시:  
     - 한국소비자원 사례(2010년)에서는 이벤트 화면에 고지했으나 **활자 크기가 작아 확인이 어려웠고**, 유료전환 시 추가 고지가 없어 사업자의 책임이 50%로 제한되었습니다.  
     - 전자거래분쟁조정위원회 사례(2006년)에서는 무료 광고 유인 후 유료전환 내용이 **불명확하게 표시**되어 사업자 책임이 인정되었습니다.

2. **소비자의 인지 여부 및 동의**  
   - 무료체험 가입 시 **이용약관에 동의**했는지, 유료전환 사실을 **인지할 수 있었는지**가 중요합니다.  
   - 예시:  
     - 4개월간 이의 없이 결제한 경우(2010년 사례), 소비자도 일정 부분 책임이 있어 환금액이 50%로 제한되었습니다.

3. **관련 법령 적용**  
   - **약관의 규제에 관한 법률 제3조**(중요 내용 명시·설명의무) 및 **소비자기본법**에 따라 사업자의 고지의무 위반 시 계약 취소 또는 부분 환불이 가능합니다.  
   - 다만, 소비자가 유료전환을 인지할 수 있는 충분한 고지가 있었다면 책임이 감경될 수 있습니다.

4. **실제 환불 가능성**  
   - **부분 환불**: 사업자가 고지의무를 일부 이행했으나 불충분할 경우, 50% 환불이 가능합니다(2010년 사례).  
   - **전액 환불**: 유료전환 사실이 전혀 고지되지 않았거나, 해지 절차가 부당하게 제한된 경우 전액 환불 가능성이 높습니다.  
   - **불가능한 경우**: 소비자가 유료전환을 명확히 인지하고 동의한 경우(예: 약관 동의 후 4개월간 결제) 환불이 어려울 수 있습니다.

### 권장 조치  
- **사업자 측에 환불 요청** 시, 유료전환 고지의 불충분함을 증거로 제시하세요(예: 작은 글씨, 불분명한 표시).  
- 협의가 어려울 경우 **한국소비자원** 또는 **전자거래분쟁조정위원회**에 조정을 신청할 수 있습니다.  

※ 단, 구체적인 사안은 **계약 내용, 고지 방식, 소비자 동의 여부** 등에 따라 결과가 달라질 수 있으므로, 정확한 판단을 위해 전문가 상담을 권장합니다.

📜 [참조 문서]
  1. 페이지: 100
  2. 페이지: 101
  3. 페이지: 102
  4. 페이지: 103
  5. 페이지: 4

===================================================
🔍 질문: 미성년자가 부모 동의 없이 게임 아이템을 구매했습니다. 환불받을 수 있는 방법이 있나요?
===================================================
✅ [전문 법률 조언]
제공된 조정결정례에 따르면, 미성년자가 부모 동의 없이 게임 아이템을 구매한 경우 환불 가능성은 다음과 같은 요소에 따라 달라집니다.  

### 1. **환불 가능한 경우**  
   - **미성년자 본인 명의로 결제**하고, **법정 대리인(부모)의 동의 없이 단독으로 계약**한 경우, 민법 제5조(미성년자의 능력)에 따라 계약을 취소할 수 있습니다.  
     - 예: 2006년 사례(2006_미성년자 단독으로 한 결제 취소 청구)에서 초등학생 자녀가 부모 모르게 성인 아이디로 결제한 경우, **미성년자 본인 명의 결제분에 한해 환불**이 권고되었습니다.  
   - 단, 미성년자가 **사술(속임수)을 사용한 경우**(예: 성인 명의를 도용하거나 성인인 것처럼 속인 경우)에는 환불이 제한될 수 있습니다.  

### 2. **환불 어려운 경우**  
   - **타인(성인)의 명의를 도용**하여 결제한 경우, 이는 불법행위로 간주되어 환불이 어려울 수 있습니다.  
     - 예: 2008년 사례(2008_부당결제대금 반환 청구)에서 미성년자가 타인의 주민번호로 가입 후 결제한 경우, **부모(신청인)와 게임사(피신청인)가 손해 분담**하도록 조정되었습니다(부모 65%, 게임사 35%).  
   - 게임사가 **실명인증 절차를 이행하지 않아** 미성년자의 불법 가입을 방치한 경우, 게임사도 일부 책임을 질 수 있습니다.  

### 3. **실제 환불 절차**  
   - **전자거래분쟁조정위원회**에 분쟁조정을 신청하거나, 게임사에 직접 환불을 요청할 수 있습니다.  
   - 게임사가 환불을 거부할 경우, **미성년자 계약 취소**를 주장하며 법적 조치(소송 등)를 고려할 수 있으나, 사술 사용 여부에 따라 결과가 달라질 수 있습니다.  

### 4. **예방 조치**  
   - 부모는 자녀의 게임 결제 내역을 정기적으로 확인하고, **신용카드/휴대폰 결제 시 본인인증 강화**를 요청해야 합니다.  
   - 게임사는 **미성년자 결제 시 부모 동의 절차**를 의무화해야 합니다(2006년 사례에서 권고된 사항).  

### 결론  
**"미성년자 본인 명의로 결제하고 사술을 사용하지 않았다면 환불 가능성이 높습니다. 다만, 타인 명의를 도용하거나 성인인 것처럼 속인 경우 환불이 제한될 수 있으며, 이 경우 게임사와 부모가 책임을 분담할 수 있습니다."**  

구체적인 사안은 **전자거래분쟁조정위원회** 또는 법률 전문가와 상담하는 것이 권장됩니다.

📜 [참조 문서]
  1. 페이지: 50
  2. 페이지: 43
  3. 페이지: 51
  4. 페이지: 52
  5. 페이지: 53

===================================================
🔍 질문: 온라인 교육 서비스가 광고와 다르게 제공되어 계약을 해지하고 싶습니다. 가능한가요?
===================================================
✅ [전문 법률 조언]
온라인 교육 서비스가 광고와 다르게 제공된 경우, 계약 해지가 가능합니다. 한국소비자원의 조정결정례에 따르면 다음과 같은 법적 근거와 기준이 적용됩니다:

### 1. **계약 해지 권리**
   - **방문판매 등에 관한 법률 제29조**에 따라 계속적 거래(1년 계약 등)의 경우 소비자는 언제든지 계약을 해지할 수 있습니다.  
   - 특히 서비스 내용이 광고와 현저히 다르거나 계약 조건을 위반한 경우, **민법 제543조(채무불이행으로 인한 계약해제)**에 따라 해지 및 환급을 요구할 수 있습니다.

### 2. **환급 기준**
   - **소비자분쟁해결기준(공정위 고시, 인터넷콘텐츠업)**에 따라 다음과 같이 환급이 이루어져야 합니다:
     - **이용 일수만큼 공제** 후 잔액 환급.
     - 위약금은 **총 이용요금의 10% 이내**로 제한됩니다.
     - 사은품 미사용 시 반환 또는 비용 공제 불가.
   - 계약서에 명시되지 않은 추가 비용(교재비, 가입비 등)은 공제 대상이 아닙니다(2007_온라인통신교육서비스 대금 환급 요구2 사례 참조).

### 3. **주의사항**
   - 해지 의사를 **서면(이메일, 내용증명 등)으로 명확히 전달**해야 합니다.
   - 서비스 미제공 또는 계약 위반 증거를 확보(광고 자료, 이용 기록 등)하는 것이 중요합니다.

### 4. **분쟁 발생 시**
   - 사업자와 협의가 어려울 경우 **한국소비자원** 또는 **소비자분쟁조정위원회**에 조정을 신청할 수 있습니다.

따라서, 광고와 다른 서비스 제공 시 계약 해지와 환급 요구가 가능하며, 과도한 위약금 또는 부당한 공제는 법적 기준에 따라 거부해야 합니다. 구체적인 사안은 계약서 내용과 증거를 바탕으로 전문가와 상담하는 것이 좋습니다.

📜 [참조 문서]
  1. 페이지: 3
  2. 페이지: 74
  3. 페이지: 64
  4. 페이지: 60
  5. 페이지: 62

✅ 8단계: 분쟁 유형 분류 테스트...
'온라인 게임에서 시스템 오류로 아이템이 사라졌는데, 게임회사가 복구를 거부하고 있습니다. 어떻게 해결할 수 있나요?' → 게임
'인터넷 강의를 중도 해지하려고 하는데 과도한 위약금을 요구받고 있습니다. 정당한가요?' → 이러닝
'무료체험 후 자동으로 유료전환되어 요금이 청구되었습니다. 환불 가능한가요?' → 이러닝
'미성년자가 부모 동의 없이 게임 아이템을 구매했습니다. 환불받을 수 있는 방법이 있나요?' → 게임
'온라인 교육 서비스가 광고와 다르게 제공되어 계약을 해지하고 싶습니다. 가능한가요?' → 기타
"""